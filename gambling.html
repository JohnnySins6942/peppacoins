<html>
    <head>
        <title> Form </title>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-database.js"></script>
        <script src="main.js"></script>
        <link rel="stylesheet" href="main.css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    </head>

    <div id="loading"></div>

    <script>

        bettingReturn = 2;
        betAmount = 1;
        tempGamble = "";
        returnRate = 49.5;
        LessThanGamble = 50500;
        var Auth  = firebase.auth();
        rolledNumber = null;
        x = false;

        $(document).ready(function(){
            firebase.auth().onAuthStateChanged(user => {
            var docRef = db.collection("users").doc(Auth.currentUser.uid);
                docRef.get().then((doc) => {
                if (doc.exists) {
                    data = doc.data();
                    $("#peppaAmount").text("Your Wallet: " + Number(data.Coins).toFixed(4).toString() + " PEPPAS");
                }
            })
        })
            $("#gamblingReturn").on("change", function(){
                // Print entered value in a div box
                tempGamble = Number($(this).val());
                if(Number(tempGamble) < 1.012 ){
                    tempGamble = 1.012;
                    $("#gamblingReturn").val(tempGamble.toString());
                }
                if(Number(tempGamble) > 750)
                {
                    tempGamble = 750;
                    $("#gamblingReturn").val(tempGamble.toString());
                }
                bettingReturn = Number(tempGamble);
                returnRate = (Math.pow((Math.sqrt(100/(bettingReturn))/10),2.029).toFixed(6) * 100).toFixed(4)
                LessThanGamble = Math.round(100000 - (returnRate * 1000));
                console.log(LessThanGamble)

                $("#result").text((betAmount * (bettingReturn)).toString() + " PEPPAS");     
                $("#ChangePercent").text(returnRate.toString() + "%");   
                $("#lessThanOdds").text(">" + LessThanGamble.toString());  
            });
            $("#gamblingAmount").on("change", function(){
                // Print entered value in a div box
                var docRef = db.collection("users").doc(Auth.currentUser.uid);
                docRef.get().then((Receivedoc) => {
                                    if (Receivedoc.exists) {
                                        var Rdata = Receivedoc.data();
                                        var coins = Rdata.Coins;
                                        betAmount = Number($(this).val());
                                        x=true

                if(Number(betAmount) < 1 && Rdata.Coins > 0){
                    betAmount = 1;
                    $("#gamblingAmount").val(betAmount.toString());
                }
                else if(Rdata.Coins < 0){
                    betAmount = 0;
                    $("#gamblingAmount").val(betAmount.toString());
                }
                if(Number(betAmount) > Number(coins))
                {
                    betAmount = Number(coins);
                    $("#gamblingAmount").val(betAmount.toString());
                    $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");     
                }
                returnRate = 100 - (Math.sqrt(bettingReturn/99000) * 100)
                // Print entered value in a div box
                $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");  
            }
        })   
            });
        }); 
        function Gamble()
        {
            rolledNumber = Math.floor(Math.random() * 100000)
            $("#finalRoll").text(rolledNumber.toString());
            if(rolledNumber > LessThanGamble)
            {
                console.log(LessThanGamble);
                var docRef = db.collection("users").doc(Auth.currentUser.uid);
                docRef.get().then((Receivedoc) => {
                                    if (Receivedoc.exists) {
                                        var Rdata = Receivedoc.data();
                                        var Rcoins = Rdata.Coins;
                                        if(Rcoins > 0)
                                        {
                                            console.log(Rcoins)
                                        var ReceivetempCoin = Number(Rcoins) + Number(betAmount * bettingReturn);  
                                        console.log(ReceivetempCoin)
                                        var tempReceiveData = {
                                            Coins: ReceivetempCoin,
                                            BlocksMined: Rdata.BlocksMined,
                                            Address: Rdata.Address,
                                            Transactions: Rdata.Transactions,
                                            newFaucetTime: Rdata.newFaucetTime,
                                            ReferralCode: Rdata.ReferralCode,
                                            Referrals: Rdata.Referrals,
                                            Referrer: Rdata.Referrer,
                                            Multiplier: Rdata.Multiplier,
                                            PreviousTransactions: Rdata.PreviousTransactions
                                        }

                                        var ReceiveTransactionObj = {
                                            ReceiverAddress: Rdata.Address,
                                            SenderAddress: Rdata.Address,
                                            TransactionDate: new Date(),
                                            Amount: Number(betAmount),
                                            send: false
                                        }
                                        tempReceiveData.Transactions.push(ReceiveTransactionObj);
                                        db.collection("users").doc(Auth.currentUser.uid).set(tempReceiveData).then(() => {
                                            alert("You won " + (betAmount * bettingReturn).toFixed(4).toString() + " PEPPAS with a " + (bettingReturn) + "x return rate. You rolled a " + rolledNumber.toString());
                                            $(document).ready(function(){
                                            firebase.auth().onAuthStateChanged(user => {
                                            var docRef = db.collection("users").doc(Auth.currentUser.uid);
                                                docRef.get().then((doc) => {
                                                if (doc.exists) {
                                                    data = doc.data();
                                                    $("#peppaAmount").text("Your Wallet: " + data.Coins.toFixed(4).toString() + " PEPPAS");
                                                    betAmount = "1";
                                                    $("#gamblingAmount").val("1");
                                                    $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");     
                                                }
                                            })
                                        })
                                    })
                                        })
                                    }else{
                                    alert("You cant bet with no PeppaCoins in your wallet!")
                                }
                                    }
                                })
                                
                                .catch((error) => {
                                    alert("there was unfortunately a transaction error...")
                                    console.error("Error adding document: ", error);
                                }); 
            }
            else if(rolledNumber < LessThanGamble){
                var docRef2 = db.collection("users").doc(Auth.currentUser.uid);
                docRef2.get().then((Receivedoc2) => {
                                    if (Receivedoc2.exists) {
                                        var Rdata2 = Receivedoc2.data();
                                        var Rcoins2 = Rdata2.Coins;
                                        if(Rcoins2 > 0)
                                        {
                                        var ReceivetempCoin2 = Number(Rcoins2) - betAmount;  
                                        var tempReceiveData2 = {
                                            Coins: ReceivetempCoin2,
                                            BlocksMined: Rdata2.BlocksMined,
                                            Address: Rdata2.Address,
                                            Transactions: Rdata2.Transactions,
                                            newFaucetTime: Rdata2.newFaucetTime,
                                            ReferralCode: Rdata2.ReferralCode,
                                            Referrals: Rdata2.Referrals,
                                            Referrer: Rdata2.Referrer,
                                            Multiplier: Rdata2.Multiplier,
                                            PreviousTransactions: Rdata2.PreviousTransactions
                                        }

                                        var ReceiveTransactionObj2 = {
                                            ReceiverAddress: Rdata2.Address,
                                            SenderAddress: Rdata2.Address,
                                            TransactionDate: new Date(),
                                            Amount: Number(betAmount),
                                            send: true,
                                            NetworkFee: 0
                                        }
                                        tempReceiveData2.Transactions.push(ReceiveTransactionObj2);
                                        db.collection("users").doc(Auth.currentUser.uid).set(tempReceiveData2).then(() => {
                                            alert("You lost " + Number(betAmount).toFixed(4).toString() + " PEPPAS with a " + (bettingReturn) + "x return rate. You rolled a " + rolledNumber.toString());
                                            $(document).ready(function(){
                                            firebase.auth().onAuthStateChanged(user => {
                                            var docRef = db.collection("users").doc(Auth.currentUser.uid);
                                                docRef.get().then((doc) => {
                                                if (doc.exists) {
                                                    data = doc.data();
                                                    $("#peppaAmount").text("Your Wallet: " + data.Coins.toFixed(4).toString() + " PEPPAS");
                                                    betAmount = 1;
                                                    $("#gamblingAmount").val("1");
                                                    $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");     
                                                }
                                            })
                                        })
                                    })
                                        })
                                    }else{
                                    alert("You cant bet with no PeppaCoins in your wallet!")
                                }
                                    }
                                })
                                
                                .catch((error) => {
                                    alert("there was unfortunately a transaction error...")
                                    console.error("Error adding document: ", error);
                                }); 
            }
        }
    </script>


    <body>
        <div>
        <button onclick = "Navigate('wallet')" id = "wallet">Wallet</button>
        <button onclick = "Navigate('faucet')" id = "faucet">Faucet</button>
        <button onclick = "Navigate('gambling')" id = "gambling">Gambling</button>
        <button onclick = "Navigate('trade')" id = "trade">Trade</button>
        <button onclick = "Navigate('referrals')" id = "referrals">Referrals</button>
        <button onclick="signOut()" id="signOut">Sign Out</button>
        <h1 id = "PeppaPrice">PeppaCoins Price: 0.000000006USD</h1>
        </div>
        <h1 id= "peppaAmount" >Your Wallet: 500 PEPPAS</h1>

        <h2 id="GamblingTitle">Gambling</h2>
        <input type="number" placeholder="Gambling Amount" id="gamblingAmount" value = "1"/>
        <input type="number" placeholder="Gambling Return" id="gamblingReturn" value = "2"/>


        <h2>Gambling Return</h2>
        <h2 id="result">2 Peppas</h2>
        <h2 id="ChangePercent">49.5000%</h2>
        <h2 id="lessThanOdds"> >50500</h2>
        <button class = "button" onclick="Gamble()" id="faucetSend">Gamble PEPPA!</button>

        <h2 id="finalRoll"></h2>
    </body>
</html>
