<html>
    <head>
        <title> Form </title>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-database.js"></script>
        <script src="main.js"></script>
        <link rel="stylesheet" href="gambling.css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    </head>

    <div id="loading"></div>

    <script>

        bettingReturn = 2;
        betAmount = 1;
        tempGamble = "";
        returnRate = 49.5;
        LessThanGamble = 50500;
        var Auth  = firebase.auth();
        rolledNumber = null;
        x = false;

        $(document).ready(function(){
            firebase.auth().onAuthStateChanged(user => {
            var docRef = db.collection("users").doc(Auth.currentUser.uid);
                docRef.get().then((doc) => {
                if (doc.exists) {
                    data = doc.data();
                    $("#peppaAmount").text("Balance: " + Number(data.Coins).toFixed(4).toString() + " PEPPAS");
                    $("#peppaAmount2").text("Balance: " + Number(data.Coins).toFixed(4).toString() + " PEPPAS");

                }
            })
        })
            $("#gamblingReturn").on("change", function(){
                // Print entered value in a div box
                tempGamble = Number($(this).val());
                if(Number(tempGamble) < 1.012 ){
                    tempGamble = 1.012;
                    $("#gamblingReturn").val(tempGamble.toString());
                }
                if(Number(tempGamble) > 750)
                {
                    tempGamble = 750;
                    $("#gamblingReturn").val(tempGamble.toString());
                }
                bettingReturn = Number(tempGamble);
                returnRate = (Math.pow((Math.sqrt(100/(bettingReturn))/10),2.029).toFixed(6) * 100).toFixed(4)
                LessThanGamble = Math.round(100000 - (returnRate * 1000));
                console.log(LessThanGamble)

                $("#result").text((betAmount * (bettingReturn)).toString() + " PEPPAS");     
                $("#ChangePercent").text(returnRate.toString() + "%");   
                $("#lessThanOdds").text(">" + LessThanGamble.toString());  
            });
            $("#gamblingAmount").on("change", function(){
                // Print entered value in a div box
                var docRef = db.collection("users").doc(Auth.currentUser.uid);
                docRef.get().then((Receivedoc) => {
                                    if (Receivedoc.exists) {
                                        var Rdata = Receivedoc.data();
                                        var coins = Rdata.Coins;
                                        betAmount = Number($(this).val());
                                        x=true

                if(Number(betAmount) < 1 && Rdata.Coins > 0){
                    betAmount = 1;
                    $("#gamblingAmount").val(betAmount.toString());
                }
                else if(Rdata.Coins < 0){
                    betAmount = 0;
                    $("#gamblingAmount").val(betAmount.toString());
                }
                if(Number(betAmount) > Number(coins))
                {
                    betAmount = Number(coins);
                    $("#gamblingAmount").val(betAmount.toString());
                    $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");     
                }
                returnRate = 100 - (Math.sqrt(bettingReturn/99000) * 100)
                // Print entered value in a div box
                $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");  
            }
        })   
            });
        }); 
        function Gamble()
        {
            rolledNumber = Math.floor(Math.random() * 100000)
            $("#finalRoll").text(rolledNumber.toString());
            if(rolledNumber > LessThanGamble)
            {
                console.log(LessThanGamble);
                var docRef = db.collection("users").doc(Auth.currentUser.uid);
                docRef.get().then((Receivedoc) => {
                                    if (Receivedoc.exists) {
                                        var Rdata = Receivedoc.data();
                                        var Rcoins = Rdata.Coins;
                                        if(Rcoins > 0)
                                        {
                                        var ReceivetempCoin = Number(Rcoins) + (Number(betAmount * bettingReturn)/2);  
                                        console.log(ReceivetempCoin)
                                        var tempReceiveData = {
                                            Coins: ReceivetempCoin,
                                            BlocksMined: Rdata.BlocksMined,
                                            Address: Rdata.Address,
                                            Transactions: Rdata.Transactions,
                                            newFaucetTime: Rdata.newFaucetTime,
                                            ReferralCode: Rdata.ReferralCode,
                                            Referrals: Rdata.Referrals,
                                            Referrer: Rdata.Referrer,
                                            Multiplier: Rdata.Multiplier,
                                            PreviousTransactions: Rdata.PreviousTransactions
                                        }

                                        var ReceiveTransactionObj = {
                                            SenderAddress: "PeppaCoins Casino",
                                            TransactionDate: new Date(),
                                            Amount: Number(betAmount),
                                            send: false
                                        }
                                        tempReceiveData.Transactions.push(ReceiveTransactionObj);
                                        db.collection("users").doc(Auth.currentUser.uid).set(tempReceiveData).then(() => {
                                            alert("You won " + (betAmount * bettingReturn).toFixed(4).toString() + " PEPPAS with a " + (bettingReturn) + "x return rate. You rolled a " + rolledNumber.toString());
                                            $(document).ready(function(){
                                            firebase.auth().onAuthStateChanged(user => {
                                            var docRef = db.collection("users").doc(Auth.currentUser.uid);
                                                docRef.get().then((doc) => {
                                                if (doc.exists) {
                                                    data = doc.data();
                                                    $("#peppaAmount").text("Your Wallet: " + data.Coins.toFixed(4).toString() + " PEPPAS");
                                                    betAmount = "1";
                                                    $("#gamblingAmount").val("1");
                                                    $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");     
                                                }
                                            })
                                        })
                                    })
                                        })
                                    }else{
                                    alert("You cant bet with no PeppaCoins in your wallet!")
                                }
                                    }
                                })
                                
                                .catch((error) => {
                                    alert("there was unfortunately a transaction error...")
                                    console.error("Error adding document: ", error);
                                }); 
            }
            else if(rolledNumber < LessThanGamble){
                var docRef2 = db.collection("users").doc(Auth.currentUser.uid);
                docRef2.get().then((Receivedoc2) => {
                                    if (Receivedoc2.exists) {
                                        var Rdata2 = Receivedoc2.data();
                                        var Rcoins2 = Rdata2.Coins;
                                        if(Rcoins2 > 0)
                                        {
                                        var ReceivetempCoin2 = Number(Rcoins2) - betAmount;  
                                        var tempReceiveData2 = {
                                            Coins: ReceivetempCoin2,
                                            BlocksMined: Rdata2.BlocksMined,
                                            Address: Rdata2.Address,
                                            Transactions: Rdata2.Transactions,
                                            newFaucetTime: Rdata2.newFaucetTime,
                                            ReferralCode: Rdata2.ReferralCode,
                                            Referrals: Rdata2.Referrals,
                                            Referrer: Rdata2.Referrer,
                                            Multiplier: Rdata2.Multiplier,
                                            PreviousTransactions: Rdata2.PreviousTransactions
                                        }

                                        var ReceiveTransactionObj2 = {
                                            ReceiverAddress: "PeppaCoins Casino",
                                            TransactionDate: new Date(),
                                            Amount: Number(betAmount),
                                            send: true,
                                            NetworkFee: 0
                                        }
                                        tempReceiveData2.Transactions.push(ReceiveTransactionObj2);
                                        db.collection("users").doc(Auth.currentUser.uid).set(tempReceiveData2).then(() => {
                                            alert("You lost " + Number(betAmount).toFixed(4).toString() + " PEPPAS with a " + (bettingReturn) + "x return rate. You rolled a " + rolledNumber.toString());
                                            $(document).ready(function(){
                                            firebase.auth().onAuthStateChanged(user => {
                                            var docRef = db.collection("users").doc(Auth.currentUser.uid);
                                                docRef.get().then((doc) => {
                                                if (doc.exists) {
                                                    data = doc.data();
                                                    $("#peppaAmount").text("Your Wallet: " + data.Coins.toFixed(4).toString() + " PEPPAS");
                                                    betAmount = 1;
                                                    $("#gamblingAmount").val("1");
                                                    $("#result").text(betAmount * (bettingReturn).toString() + " PEPPAS");     
                                                }
                                            })
                                        })
                                    })
                                        })
                                    }else{
                                    alert("You cant bet with no PeppaCoins in your wallet!")
                                }
                                    }
                                })
                                
                                .catch((error) => {
                                    alert("there was unfortunately a transaction error...")
                                    console.error("Error adding document: ", error);
                                }); 
            }
        }
    </script>


    <body>
    <div class="page">
            <div class="sidenav">
            <h4 id = "PeppaPrice" style="text-align: center;">PeppaCoins Price: 0.000000006USD</h4>
            <button style="margin-left:18px;"class="btn pink"id="wallet"style="z-index: 3;"onclick = "Navigate('wallet')">Wallet</button>
            <button style="margin-left:17px;"class="btn pink"id="faucet"style="z-index: 3;"onclick = "Navigate('faucet')">Faucet</button>
            <button style="margin-left:16px;"class="btn pink"id="gambling"style="z-index: 3;"onclick = "Navigate('gambling')">Gambling</button>
            <button style="margin-left:15px;"class="btn pink"id="trade"style="z-index: 3;"onclick = "Navigate('trade')">Trade</button>
            <button style="margin-left:14px;"class="btn pink"id="referrals"style="z-index: 3;"onclick = "Navigate('referrals')">Referrals</button>
            <br><br><br><br><br><br><br><br><br><Br><br><br><br>
            <button style="margin-left:14px;margin-bottom:5px;"class="btn pink"id="signOut"style="z-index: 3;"onclick = "signOut()">Sign Out</button>
            </div>
        <div class="gambling">
            
            
        <div class="topnav">
            <a style="margin-top:10px;margin-left:1%;"><button class="btn pink"id="wallet"style="z-index: 3;">PeppaBet</button></a>
            <a style="margin-top:10px;"><button class="btn pink"id="wallet"style="z-index: 3;">Fairness</button></a>
            <a style="margin-top:10px;"><button class="btn pink"id="wallet"style="z-index: 3;">FAQ</button></a>
            <a style="margin-top:10px;"><button style="margin-left:17px;"class="btn pink"id="faucet"style="z-index: 3;"onclick = "Navigate('faucet')">Faucet</button></a>
            <a style="margin-top:-65px; margin-left:76%;"><h4 style="text-align:center" id= "peppaAmount" >Balance: 500 PEPPAS</h4></a>
    </div>
    <div class="BetPanel">
        <br style="display: block;
        line-height:0px;">
        <h5 style="margin-left:2%;"id="peppaAmount2">Gambling</h5>
        <input style="width:30%; height:10%;margin-left:1.5%"type="number" id="gamblingAmount" name="firstname" placeholder="Bet Amount" value="0"/>
        <input style="width:30%; height:10%;margin-left:25%"type="number" placeholder="Gambling Return" id="gamblingReturn" value = "2"/>

        <h2>Gambling Return</h2>
        <h2 id="result">2 Peppas</h2>
        <h2 id="ChangePercent">49.5000%</h2>
        <h2 id="lessThanOdds"> >50500</h2>
        <button class = "button" onclick="Gamble()" id="faucetSend">Gamble PEPPA!</button>

        <h2 id="finalRoll">34</h2>
    </div>
        </div>
    </div>
    </body>
</html>